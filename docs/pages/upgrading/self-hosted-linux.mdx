---
title: Upgrade Self-Hosted Teleport Clusters on Linux
description: Provides instructions for upgrading self-hosted Teleport clusters that run on Linux servers. 
---

This guide explains how to upgrade self-hosted Teleport clusters running on
Linux servers.

## Prerequisites

- Familiarity with the [Upgrading Compatibility Overview](./overview.mdx) guide,
  which describes the sequence in which to upgrade components of your cluster.

- A self-hosted Teleport cluster in which the Auth Service and Proxy Service run
  on Linux servers. Auth Service and Proxy Service instances must be running a
  previous version of Teleport.

  You must reduce the size of the Auth Service pool to one in order to perform
  an upgrade.

Teleport supports automatic agent updates for systemd-based Linux distributions
using `apt`, `yum`, and `zypper` package managers. The [Automatic Update Architecture
](../../architecture/agent-update-management.mdx) guide describes how agent
updating works. Automatic agent upgrades require:

- A Teleport cluster running version 13.0 or above.
- At least one Teleport Enterprise agent, started via systemd on a distribution
  using the `apt` or `yum` package managers.
- A **version server** in your infrastructure that agents can query in order to
  upgrade themselves. Read [Set up Automatic Upgrade
  Infrastructure](./self-hosted-automatic-agent-updates.mdx).

  If your environment does not support automatic upgrades, you can follow the
  same instructions to upgrade agents that you used to upgrade the Auth Service
  and Proxy Service.

## Step 1/2. Upgrade the Auth Service and Proxy Service

Complete the following steps on all servers that run the Auth Service and Proxy
Service:

1. Install the latest Teleport version on the host. Open a terminal and export
   the Teleport edition as an environment variable called `TELEPORT_EDITION`.
   Use the following table to choose the value:

   |Edition|Value|
   |---|---|
   |Teleport Community Edition|`teleport`|
   |Teleport Team, Enterprise, and Enterprise Cloud|`teleport-ent`|
   |Teleport Entrprise (FIPS builds)|`teleport-ent-fips`|
   
   ```code
   $ export TELEPORT_EDITION="teleport-ent"
   ```
1. Run the following commands to install the latest version of Teleport on your
   Linux server:
   
   <Tabs>
   <TabItem label="Debian 9+/Ubuntu 16.04+ (apt)">
   
   ```code
   # Download Teleport's PGP public key
   $ sudo curl https://apt.releases.teleport.dev/gpg \
   -o /usr/share/keyrings/teleport-archive-keyring.asc
   # Source variables about OS version
   $ source /etc/os-release
   # Add the Teleport APT repository for v(=teleport.major_version=). You'll need to update this
   # file for each major release of Teleport.
   $ echo "deb [signed-by=/usr/share/keyrings/teleport-archive-keyring.asc] \
   https://apt.releases.teleport.dev/${ID?} ${VERSION_CODENAME?} stable/v(=teleport.major_version=)" \
   | sudo tee /etc/apt/sources.list.d/teleport.list > /dev/null
   
   $ sudo apt-get update
   $ sudo apt-get install ${TELEPORT_EDITION:=teleport}
   ```
   
   </TabItem>
   <TabItem label="Amazon Linux 2/RHEL 7 (yum)">
   
   ```code
   # Source variables about OS version
   $ source /etc/os-release
   # Add the Teleport YUM repository for v(=teleport.major_version=). You'll need to update this
   # file for each major release of Teleport.
   # First, get the major version from $VERSION_ID so this fetches the correct
   # package version.
   $ VERSION_ID=$(echo $VERSION_ID | grep -Eo "^[0-9]+")
   $ sudo yum-config-manager --add-repo "$(rpm --eval "https://yum.releases.teleport.dev/$ID/$VERSION_ID/Teleport/%{_arch}/stable/v(=teleport.major_version=)/teleport.repo")"
   $ sudo yum install ${TELEPORT_EDITION:=teleport}
   #
   # Tip: Add /usr/local/bin to path used by sudo (so 'sudo tctl users add' will work as per the docs)
   # echo "Defaults    secure_path = /sbin:/bin:/usr/sbin:/usr/bin:/usr/local/bin" > /etc/sudoers.d/secure_path
   ```
   
   </TabItem>
   <TabItem label="Amazon Linux 2/RHEL 7 (zypper)">
   
   ```code
   # Source variables about OS version
   $ source /etc/os-release
   # Add the Teleport Zypper repository for v(=teleport.major_version=). You'll need to update this
   # file for each major release of Teleport.
   # First, get the OS major version from $VERSION_ID so this fetches the correct
   # package version.
   $ VERSION_ID=$(echo $VERSION_ID | grep -Eo "^[0-9]+")
   # Use zypper to add the teleport RPM repo
   $ sudo zypper addrepo --refresh --repo $(rpm --eval "https://zypper.releases.teleport.dev/$ID/$VERSION_ID/Teleport/%{_arch}/stable/cloud/teleport-zypper.repo")
   $ sudo yum install ${TELEPORT_EDITION:=teleport}
   #
   # Tip: Add /usr/local/bin to path used by sudo (so 'sudo tctl users add' will work as per the docs)
   # echo "Defaults    secure_path = /sbin:/bin:/usr/sbin:/usr/bin:/usr/local/bin" > /etc/sudoers.d/secure_path
   ```
   
   </TabItem>
   <TabItem label="Amazon Linux 2023/RHEL 8+ (dnf)">
   
   ```code
   # Source variables about OS version
   $ source /etc/os-release
   # Add the Teleport YUM repository for v(=teleport.major_version=). You'll need to update this
   # file for each major release of Teleport.
   # First, get the major version from $VERSION_ID so this fetches the correct
   # package version.
   $ VERSION_ID=$(echo $VERSION_ID | grep -Eo "^[0-9]+")
   # Use the dnf config manager plugin to add the teleport RPM repo
   $ sudo dnf config-manager --add-repo "$(rpm --eval "https://yum.releases.teleport.dev/$ID/$VERSION_ID/Teleport/%{_arch}/stable/v(=teleport.major_version=)/teleport.repo")"
   
   # Install teleport
   $ sudo dnf install ${TELEPORT_EDITION:=teleport}
   
   # Tip: Add /usr/local/bin to path used by sudo (so 'sudo tctl users add' will work as per the docs)
   # echo "Defaults    secure_path = /sbin:/bin:/usr/sbin:/usr/bin:/usr/local/bin" > /etc/sudoers.d/secure_path
   ```
   
   </TabItem>
   <TabItem label="SLES 12 SP5+ and 15 SP5+ (zypper)">
   
   ```code
   # Source variables about OS version
   $ source /etc/os-release
   # Add the Teleport Zypper repository.
   # First, get the OS major version from $VERSION_ID so this fetches the correct
   # package version.
   $ VERSION_ID=$(echo $VERSION_ID | grep -Eo "^[0-9]+")
   # Use Zypper to add the teleport RPM repo
   $ sudo zypper addrepo --refresh --repo $(rpm --eval "https://zypper.releases.teleport.dev/$ID/$VERSION_ID/Teleport/%{_arch}/stable/v(=teleport.major_version=)/teleport-zypper.repo")
   
   # Install teleport
   $ sudo zypper install ${TELEPORT_EDITION:=teleport}
   ```
   
   </TabItem>
   <TabItem label="Tarball" >
   
   In the example commands below, update `$SYSTEM_ARCH` with the appropriate
   value (`amd64`, `arm64`, or `arm`). All example commands using this variable
   will update after one is filled out.
   
   ```code
   $ curl https://get.gravitational.com/${TELEPORT_EDITION:=teleport}-v(=teleport.version=)-linux-<Var name="$SYSTEM_ARCH"/>-bin.tar.gz.sha256
   # <checksum> <filename>
   $ curl -O https://cdn.teleport.dev/${TELEPORT_EDITION:=teleport}-v(=teleport.version=)-linux-<Var name="$SYSTEM_ARCH"/>-bin.tar.gz
   $ shasum -a 256 ${TELEPORT_EDITION:=teleport}-v(=teleport.version=)-linux-<Var name="$SYSTEM_ARCH"/>-bin.tar.gz
   # Verify that the checksums match
   $ tar -xvf ${TELEPORT_EDITION:=teleport}-v(=teleport.version=)-linux-<Var name="$SYSTEM_ARCH"/>-bin.tar.gz
   $ cd ${TELEPORT_EDITION:=teleport}
   $ sudo ./install
   ```
   
   </TabItem>
   </Tabs>

1. Now that you have installed a more recent `teleport` binary on your Auth
   Service and Proxy Service servers, restart Teleport on these servers to run
   the new version.

   (!docs/pages/includes/start-teleport.mdx!)

## Step 2/2. Enroll agents in automatic upgrades

Follow these instructions on each of your Teleport agents.

1. Ensure the Teleport repository is added and Teleport Enterprise is installed.

   To verify if the Teleport repository was added to the system, check if either of the follow files exist:
   ```code
   $ ls /etc/apt/sources.list.d/teleport.list
   # or
   $ ls /etc/yum.repos.d/teleport.repo
   ```
   
   If the Teleport repository is not found, add the appropriate repository and reinstall Teleport:
   
   (!docs/pages/includes/cloud/install-linux-cloud.mdx!)

1. Configure the updater: 

   Create the upgrade configuration directory:
   
   ```code
   $ sudo mkdir -p /etc/teleport-upgrade.d/
   ```
   
   If you changed the agent user to run as non-root, create
   `/etc/teleport-upgrade.d/schedule` and grant ownership to your Teleport user.
   Else, you can skip this step:
   
   ```code
   $ sudo touch /etc/teleport-upgrade.d/schedule
   $ sudo chown <Var name="your-teleport-user" /> /etc/teleport-upgrade.d/schedule
   ```
   
   Configure the updater to connect to your custom version server and subscribe
   to the right release channel:
   
   ```code
   $ echo <Var name="version-server-url/path" />/<Var name="release-channel" /> | sudo tee /etc/teleport-upgrade.d/endpoint
   ```
   
   <Admonition type="tip" title="Note">
   Make sure not to include `https://` as a prefix to the server address.
   </Admonition>

1. Verify the updater is properly configured

   Verify that the updater can see your version endpoint by checking for updates:

   ```code
   $ sudo teleport-upgrade dry-run
   ```
   
   You should see one of the following messages, depending on the target version
   you are currently serving:
   
   ```text
   no upgrades available (1.2.3 == 1.2.3)
   an upgrade is available (1.2.3 -> 2.3.4)
   ```
   
   <Admonition type="note">
   `teleport-upgrade` may complain about not having a valid upgrade schedule.
   This is expected immediately after install as the maintenance schedule might
   not be exported yet.
   </Admonition>

If the agent is not automatically updated, you can invoke the updater manually
and look at its logs:

```code
$ sudo teleport-upgrade run
```

To suspend automatic upgrades, disable the systemd timer:

```code
$ sudo systemctl disable --now teleport-upgrade.timer
```

To enable and start the systemd timer after suspending:

```code
$ sudo systemctl enable --now teleport-upgrade.timer
```
